pipeline {
    agent any
    tools {
        nodejs 'nodejs'
    }
    environment {
        containerRegistry = "f90mora/devops-test"
        GITHUB_REPO= "https://github.com/fer9003/devsu-devops-test.git"
        DATABASE_NAME = credentials('db_name')
        DATABASE_USER = credentials('db_user')
        DATABASE_PASSWORD = credentials('db_pass')
    }
stages {
    stage('Github Clone') {
        steps {
            echo "Cloning Project from Github"
            checkout scmGit(
                branches: [[name: '*/master']],
                extensions: [],
                userRemoteConfigs: [[url: GITHUB_REPO ]]
            )
        }
    }

    stage('Unit Test') {
        steps {
            sh """
            cd microservice
            npm install && npm test
            """
        }
    }

    stage('Docker Build and Push') {
        steps {
            withDockerRegistry([credentialsId: "dockerhub", url:""]) {
                sh """
                printenv
                docker build -t $containerRegistry:""$GIT_COMMIT"" .
                docker push $containerRegistry:""$GIT_COMMIT""
                """
            }
        }
    }
}
}